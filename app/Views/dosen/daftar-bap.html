<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="dosen.css">
    <link rel="stylesheet" href="BAP.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header-judul">
                <p>MONEV RPS</p> 
            </div>
            <div class="sidebar-header">
                <p>Tahun Ajaran : 2024/2025 Ganjil</p>
            </div>
            <a href="dashboard-dosen.html" class="menu-item">
                <i class="bi bi-speedometer2"></i><span>Halaman Utama</span>
            </a>
            <a href="#" class="menu-item" id="menuRPS">
                <i class="bi bi-file-earmark-arrow-up-fill"></i><span>RPS</span>
                <i class="bi bi-chevron-left chevron-icon float-end"></i>
            </a>
            <a href="unggah-rps.html" class="menu-item submenu-item" id="unggahRpsMenu" style="display: none;"><span>Unggah RPS</span></a>
            <a href="daftar-upload-rps.html" class="menu-item submenu-item" id="daftarUploadRpsMenu" style="display: none;"><span>Daftar Upload RPS</span></a>
            <a href="#" class="menu-item" id="menuBAP">
                <i class="bi bi-file-earmark-pdf-fill"></i><span>BAP</span>
                <i class="bi bi-chevron-left chevron-icon float-end"></i>
            </a>
            <a href="isi-bap.html" class="menu-item submenu-item" id="isiBapMenu" style="display: none;"><span>Isi BAP</span></a>
            <a href="daftar-bap.html" class="menu-item submenu-item" id="daftarBapMenu" style="display: none;"><span>Daftar BAP</span></a>
            <a href="feedback.html" class="menu-item">
                <img src="feedback.png" alt="Feedback Icon" class="feedback-icon"><span>Feedback RPS</span> 
            </a>
            <a href="notifikasi-rps.html" class="menu-item">
                <i class="bi bi-bell-fill"></i><span>Notifikasi</span> 
            </a>
            <a href="#" class="menu-item">
                <i class="bi bi-box-arrow-left"></i><span>Keluar</span> 
            </a>
        </nav>

        <!-- Main content -->
        <div class="admin-info">
            <span class="toggle-sidebar">&#9776;</span>
            
            <!-- Right-aligned container for profile and notification icons -->
            <div class="right-icons">
                <a href="profile.html" class="profile-link">
                    <span class="admin-name">Nama Dosen</span>
                    <i class="bi bi-person-fill"></i>
                </a>
                <a href="notifikasi-rps.html" class="notif">
                    <i class="bi bi-bell-fill"></i>
                </a>
            </div>
        </div>

        <div class="main-content">
            <!-- Administrator Info Container -->
            
            <header class="main-header">
                <h1 class="h4">Home / Daftar BAP</h1>
            </header>

            <!-- Table Section -->
            <section class="content-section">
                <div class="container">
                    <h2 class="mb-4">Daftar Berita Acara Perkuliahan (BAP)</h2>
                    <table id="daftarBapTable" class="table table-bordered">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Mata Kuliah</th>
                                <th>Kode MK</th>
                                <th>Tempat</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data diisi melalui JavaScript -->
                        </tbody>
                    </table>

                    <!-- Tambahkan modal untuk menampilkan dokumen -->
                    <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="viewModalLabel">Lihat BAP</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="viewContent"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Container Edit BAP -->
                    <div class="modal fade" id="editBapModal" tabindex="-1" aria-labelledby="editBapModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editBapModalLabel">Edit BAP</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editBapForm">
                                        <div class="mb-3">
                                            <label for="editTanggal" class="form-label">Tanggal</label>
                                            <input type="date" class="form-control" id="editTanggal" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editMataKuliah" class="form-label">Mata Kuliah</label>
                                            <input type="text" class="form-control" id="editMataKuliah" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editKodeMK" class="form-label">Kode MK</label>
                                            <input type="text" class="form-control" id="editKodeMK" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editTempat" class="form-label">Tempat</label>
                                            <input type="text" class="form-control" id="editTempat" required>
                                        </div>
                                        <h4>Catatan Review</h4>
                                        <table id="editCatatanReviewTable" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>No</th>
                                                    <th>Catatan</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="catatanReviewBody">
                                                <!-- Data catatan review diisi melalui JavaScript -->
                                            </tbody>
                                        </table>
                                        <button type="button" class="btn btn-secondary" id="addReviewBtn">Tambah Catatan Review</button>
                                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                        <button type="button" class="btn btn-secondary" id="cancelEdit">Batal</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const renderTable = () => {
                const data = JSON.parse(localStorage.getItem('daftarBap')) || [];
                const tbody = document.querySelector('#daftarBapTable tbody');
                tbody.innerHTML = '';
    
                data.forEach((item, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.tanggal}</td>
                            <td>${item.mataKuliah}</td>
                            <td>${item.kodeMK}</td>
                            <td>${item.tempat}</td>
                            <td>
                                <button class="btn btn-icon view-btn" data-index="${index}" data-bs-toggle="tooltip" data-bs-placement="top" title="Lihat">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-icon edit-btn" data-index="${index}" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-icon download-btn" data-index="${index}" data-bs-toggle="tooltip" data-bs-placement="top" title="Download PDF">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button class="btn btn-icon delete-btn" data-index="${index}" data-bs-toggle="tooltip" data-bs-placement="top" title="Hapus">
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
    
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.onclick = () => {
                        const index = button.getAttribute('data-index');
                        showEditContainer(index);
                    };
                });
    
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.onclick = () => {
                        const index = button.getAttribute('data-index');
                        deleteData(index);
                    };
                });
            };
    
            const deleteData = (index) => {
                const data = JSON.parse(localStorage.getItem('daftarBap')) || [];
                if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                    data.splice(index, 1);
                    localStorage.setItem('daftarBap', JSON.stringify(data));
                    renderTable();
                }
            };
    
            const showEditContainer = (index) => {
                const data = JSON.parse(localStorage.getItem('daftarBap')) || [];
                const item = data[index];
    
                document.getElementById('editTanggal').value = item.tanggal;
                document.getElementById('editMataKuliah').value = item.mataKuliah;
                document.getElementById('editKodeMK').value = item.kodeMK;
                document.getElementById('editTempat').value = item.tempat;
    
                const catatanReviewBody = document.getElementById('catatanReviewBody');
                catatanReviewBody.innerHTML = '';
                item.catatanReview.forEach((review, reviewIndex) => {
                    const reviewRow = `
                        <tr>
                            <td>${reviewIndex + 1}</td>
                            <td><input type="text" class="form-control" value="${review}" /></td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeReview(${index}, ${reviewIndex})">Hapus</button></td>
                        </tr>
                    `;
                    catatanReviewBody.innerHTML += reviewRow;
                });
    
                const editModal = new bootstrap.Modal(document.getElementById('editBapModal'));
                editModal.show();
    
                document.getElementById('editBapForm').onsubmit = (e) => {
                    e.preventDefault();
                    item.tanggal = document.getElementById('editTanggal').value;
                    item.mataKuliah = document.getElementById('editMataKuliah').value;
                    item.kodeMK = document.getElementById('editKodeMK').value;
                    item.tempat = document.getElementById('editTempat').value;
    
                    const reviewInputs = document.querySelectorAll('#catatanReviewBody input');
                    item.catatanReview = Array.from(reviewInputs).map(input => input.value);
    
                    localStorage.setItem('daftarBap', JSON.stringify(data));
                    alert('Data berhasil diperbarui!');
                    editModal.hide();
                    renderTable();
                };
            };
    
            document.getElementById('addReviewBtn').onclick = () => {
                const catatanReviewBody = document.getElementById('catatanReviewBody');
                const newRowIndex = catatanReviewBody.children.length;
                const newRow = `
                    <tr>
                        <td>${newRowIndex + 1}</td>
                        <td><input type="text" class="form-control" placeholder="Catatan baru" /></td>
                        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeNewReview(this)">Hapus</button></td>
                    </tr>
                `;
                catatanReviewBody.insertAdjacentHTML('beforeend', newRow);
            };
    
            window.removeNewReview = (button) => {
                button.closest('tr').remove();
                updateReviewNumbers();
            };
    
            window.removeReview = (bapIndex, reviewIndex) => {
                const data = JSON.parse(localStorage.getItem('daftarBap')) || [];
                data[bapIndex].catatanReview.splice(reviewIndex, 1);
                localStorage.setItem('daftarBap', JSON.stringify(data));
                renderTable();
                showEditContainer(bapIndex);
            };
    
            const updateReviewNumbers = () => {
                const catatanReviewBody = document.getElementById('catatanReviewBody');
                const rows = catatanReviewBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.cells[0].innerText = index + 1;
                });
            };
    
            renderTable();
    
            document.querySelectorAll('.view-btn').forEach(button => {
                button.onclick = () => {
                    const index = button.getAttribute('data-index');
                    viewDocument(index);
                };
            });
    
            function viewDocument(index) {
                const data = JSON.parse(localStorage.getItem('daftarBap')) || [];
                const item = data[index];

                const hari = getDayName(item.tanggal);
                const formattedDate = formatDate(item.tanggal);
                const content = `
                    <div style="font-family: 'Times New Roman', Times, serif; padding: 20px; border: 1px solid #000;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="width: 60px; vertical-align: middle;">
                                    <img src="LOGO_UMRAH_PNG.png" alt="Logo" style="width: 150px; height: 150px;">
                                </td>
                                <td style="text-align: center;">
                                    <h4 style="margin: 0;">KEMENTERIAN PENDIDIKAN, KEBUDAYAAN,</h4>
                                    <h4 style="margin: 0;">RISET, DAN TEKNOLOGI</h4>
                                    <h4 style="margin: 0;">UNIVERSITAS MARITIM RAJA ALI HAJI</h4>
                                    <h5 style="margin: 0; font-weight: bold;">FAKULTAS TEKNIK DAN TEKNOLOGI KEMARITIMAN</h5>
                                    <p style="margin: 0; font-size: 12px;">Jalan Politeknik Senggarang Telp. (0771) 4500097; Fax. (0771) 4500097</p>
                                    <p style="margin: 0; font-size: 12px;">PO.BOX 155 – Tanjungpinang 29100</p>
                                    <p style="margin: 0; font-size: 12px;">Website: <a href="http://fttk.umrah.ac.id/" target="_blank">http://fttk.umrah.ac.id/</a> e-mail: <a href="mailto:teknik@umrah.ac.id">teknik@umrah.ac.id</a></p>
                                </td>
                            </tr>
                        </table>
                        <hr style="border: 1px solid #000;">
                        <h5 style="text-align: center; font-weight: bold;">BERITA ACARA</h5>
                        <h5 style="text-align: center; font-weight: bold;">REVIEW RENCANA PEMBELAJARAN SEMESTER (RPS)</h5>
                        <p>Hari/tanggal: ${hari} / ${formattedDate}</p>
                        <p>Tempat: ${item.tempat}</p>
                        <p>Nama MK / Kode MK: ${item.mataKuliah} / ${item.kodeMK}</p>
                        <h6>Catatan review:</h6>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #000; padding: 5px; width: 5%;">No</th>
                                    <th style="border: 1px solid #000; padding: 5px; text-align: center;">Catatan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${item.catatanReview.map((note, i) => `
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 5px; width: 5%;">${i + 1}</td>
                                        <td style="border: 1px solid #000; padding: 5px;">${note}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('viewContent').innerHTML = content;
                const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));
                viewModal.show();
            }
    
            document.querySelectorAll('.download-btn').forEach(button => {
                button.onclick = () => {
                    const index = button.getAttribute('data-index');
                    downloadPdf(index);
                };
            });
    
            const downloadPdf = (index) => {
                const data = JSON.parse(localStorage.getItem('daftarBap')) || [];
                const item = data[index];

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const logoImg = new Image();
                logoImg.src = 'LOGO_UMRAH_PNG.png';
                logoImg.onload = function () {
                    doc.addImage(logoImg, 'PNG', 8, 11, 31, 31);
                    doc.setFontSize(14);
                    doc.setFont("Times New Roman");
                    doc.text("KEMENTERIAN PENDIDIKAN, KEBUDAYAAN,", 61, 17);
                    doc.text("RISET, DAN TEKNOLOGI", 85, 23);
                    doc.text("UNIVERSITAS MARITIM RAJA ALI HAJI", 68, 29);
                    doc.setFontSize(14);
                    doc.setFont("Times New Roman", "bold");
                    doc.text("FAKULTAS TEKNIK DAN TEKNOLOGI KEMARITIMAN", 48, 35);
                    doc.setFontSize(10);
                    doc.setFont("Times New Roman", "normal");
                    doc.text("Jalan Politeknik Senggarang Telp. (0771) 4500097; Fax. (0771) 4500097", 61, 39);
                    doc.text("PO.BOX 155 – Tanjungpinang 29100", 86, 43);
                    doc.textWithLink('Website :', 69, 47, { url: 'http://fttk.umrah.ac.id/' });
                    doc.text(' e-mail :', 115, 47);
                    doc.setTextColor(0, 0, 255); 
                    doc.textWithLink('http://fttk.umrah.ac.id/', 83, 47, { url: 'http://fttk.umrah.ac.id/' });
                    doc.textWithLink('teknik@umrah.ac.id', 127, 47, { url: 'mailto:teknik@umrah.ac.id' });
                    doc.setDrawColor(0, 0, 255);
                    doc.setLineWidth(0.3);
                    doc.line(83, 47.5, 115, 47.5);
                    doc.line(127, 47.5, 156, 47.5);
                    
                    doc.setDrawColor(0); 
                    doc.setLineWidth(0.8); 
                    doc.line(12, 49, 201, 49);

                    doc.setTextColor(0, 0, 0);
                    doc.setFont("Times New Roman", "bold");
                    doc.setFontSize(12);
                    doc.text("BERITA ACARA", 89, 60);
                    doc.text("REVIEW RENCANA PEMBELAJARAN SEMESTER (RPS)", 49, 65);

                    const hari = getDayName(item.tanggal);
                    const formattedDate = formatDate(item.tanggal);
                    doc.setFont("Times New Roman", "normal");
                    doc.setFontSize(12);
                    doc.text(`Hari/tanggal                           : ${hari} / ${formattedDate}`, 26, 81);
                    doc.text(`Tempat                                   : ${item.tempat}`, 26, 89);
                    doc.text(`Nama MK / Kode MK           : ${item.mataKuliah} / ${item.kodeMK}`, 26, 97);
                    doc.text("Catatan review", 26, 105);
                    doc.setDrawColor(0); 
                    doc.setLineWidth(0.3); 
                    doc.line(26, 105.5, 51.5, 105.5);

                    const catatanReview = item.catatanReview.map((note, i) => [`${i + 1}.`, note]);
                    doc.autoTable({
                        startY: 109,
                        head: [['No', 'Catatan Review']],
                        body: catatanReview,
                        styles: {
                            font: 'Times New Roman',
                            valign: 'middle',
                            fontSize: 12,
                            lineWidth: 0.2,
                            lineColor: [0, 0, 0],
                            textColor: [0, 0, 0]
                        },
                        headStyles: {
                            fillColor: [255, 255, 255],
                            textColor: [0, 0, 0],
                            halign: 'center'
                        },
                        columnStyles: {
                            0: { cellWidth: 10, halign: 'left' },
                            1: { cellWidth: 145, halign: 'left' }
                        },
                        margin: { left: 26 }
                    });

                    doc.save(`BAP_Review_RPS_${item.tanggal}.pdf`);
                };
            };
    
            function getDayName(dateString) {
                const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
                const date = new Date(dateString);
                return days[date.getDay()];
            }

            function formatDate(dateString) {
                const months = [
                    "Januari", "Februari", "Maret", "April", "Mei", "Juni",
                    "Juli", "Agustus", "September", "Oktober", "November", "Desember"
                ];
                const date = new Date(dateString);
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${day} ${month} ${year}`;
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 Fakultas Teknik. All rights reserved.</p>
    </footer>
    
    <script src="dosen.js"></script>

    <!-- Scripts for Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
</body>
</html>